<!DOCTYPE html>
<html>
<head>
  <title>QR Code Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>üì∑ Scan QR Code (Camera)</h2>
  <div id="reader" style="width: 300px;"></div>

  <h2>üñºÔ∏è Upload QR Code Image</h2>
  <input type="file" accept="image/*" id="qr-input-file" />

  <p id="result" style="font-weight:bold;"></p>

  <script>
    // ‚úÖ Replace this with your actual Google Apps Script Web App URL
    const scriptURL = "https://script.google.com/macros/s/AKfycbzjke47Ngkr0rCbWzBq6F6bgAbm2uuWIJd4ERxnZHVl5khebYyj1Q_OLDQJ2hCnZPf5/exec";

    // ‚úÖ Send scanned QR to Google Sheet
    async function postToSheet(qrText) {
      try {
        const response = await fetch(scriptURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ qrCode: qrText }) // ‚úÖ Must match with Apps Script
        });

        const text = await response.text();
        document.getElementById("result").innerText = "‚úÖ Sent to Google Sheet: " + qrText;
        console.log("Sheet Response:", text);
      } catch (error) {
        console.error("‚ùå Error posting to sheet:", error);
        document.getElementById("result").innerText = "‚ùå Error sending to Google Sheet.";
      }
    }

    // ‚úÖ Called on successful camera scan
    function onScanSuccess(decodedText, decodedResult) {
      console.log(`Camera Scanned: ${decodedText}`);
      postToSheet(decodedText);
      html5QrcodeScanner.clear(); // Stop scanning after success
    }

    // ‚úÖ Initialize camera scanner
    const html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);

    // ‚úÖ Upload and scan QR from image
    const fileInput = document.getElementById('qr-input-file');
    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const qrCode = new Html5Qrcode("reader");
      try {
        const result = await qrCode.scanFile(file, true);
        console.log("Image Scanned:", result);
        postToSheet(result);
      } catch (err) {
        console.error("Image scan error:", err);
        document.getElementById("result").innerText = "‚ùå Failed to scan QR from image.";
      }
    });
  </script>
</body>
</html>
